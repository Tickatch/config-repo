# ========================================
# Gateway Server 설정 (Spring Cloud 2025.0.0+)
# ========================================

spring:
  # ========================================
  # Security - JWT 검증 (OAuth2 Resource Server)
  # ========================================
  security:
    oauth2:
      resourceserver:
        jwt:
          # Auth Service의 JWKS 엔드포인트 (Eureka 서비스명 사용)
          jwk-set-uri: ${JWT_JWKS_URI:http://localhost:8090/.well-known/jwks.json}
          issuer-uri: ${JWT_ISSUER:tickatch}
  cloud:
    gateway:
      server:
        webflux:
          discovery:
            locator:
              enabled: true
              lower-case-service-id: true
          default-filters:
            - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOrigins: "*"
                allowedMethods: "*"
                allowedHeaders: "*"
          routes:
            # ========================================
            # Auth Service
            # ========================================
            - id: auth-service
              uri: lb://AUTH-SERVICE
              predicates:
                - Path=/api/v1/auth/**
              filters:
                - RewritePath=/api/v1/auth(?<segment>/?.*), /api/v1/auth$\{segment}

            - id: auth-service-jwks
              uri: lb://AUTH-SERVICE
              predicates:
                - Path=/.well-known/**
              filters:
                - RewritePath=/.well-known(?<segment>/?.*), /.well-known$\{segment}

            - id: auth-service-api-docs
              uri: lb://AUTH-SERVICE
              predicates:
                - Path=/auth-service/v3/api-docs/**
              filters:
                - RewritePath=/auth-service(?<segment>/?.*), $\{segment}

            # ========================================
            # User Service
            # ========================================
            - id: user-service
              uri: lb://USER-SERVICE
              predicates:
                - Path=/api/v1/user/**
              filters:
                - RewritePath=/api/v1/user(?<segment>/?.*), /api/v1/user$\{segment}

            - id: user-service-api-docs
              uri: lb://USER-SERVICE
              predicates:
                - Path=/user-service/v3/api-docs/**
              filters:
                - RewritePath=/user-service(?<segment>/?.*), $\{segment}

            # ========================================
            # Product Service
            # ========================================
            - id: product-service
              uri: lb://PRODUCT-SERVICE
              predicates:
                - Path=/api/v1/products/**
              filters:
                - RewritePath=/api/v1/products(?<segment>/?.*), /api/v1/products$\{segment}

            - id: product-service-api-docs
              uri: lb://PRODUCT-SERVICE
              predicates:
                - Path=/product-service/v3/api-docs/**
              filters:
                - RewritePath=/product-service(?<segment>/?.*), $\{segment}

            #
            - id: payment-service
              uri: lb://PAYMENT-SERVICE
              predicates:
                - Path=/api/v1/payments/**
              filters:
                - RewritePath=/api/v1/payments(?<segment>/?.*), /api/v1/payments$\{segment}

            - id: payment-service-api-docs
              uri: lb://PAYMENT-SERVICE
              predicates:
                - Path=/payment-service/v3/api-docs/**
              filters:
                - RewritePath=/payment-service(?<segment>/?.*), $\{segment}
            # ========================================
            # Reservation Service
            # ========================================
            - id: reservation-service
              uri: lb://RESERVATION-SERVICE
              predicates:
                - Path=/api/v1/reservations/**
              filters:
                - RewritePath=/api/v1/reservations(?<segment>/?.*), /api/v1/reservations$\{segment}

            - id: reservation-service-api-docs
              uri: lb://RESERVATION-SERVICE
              predicates:
                - Path=/reservation-service/v3/api-docs/**
              filters:
                - RewritePath=/reservation-service(?<segment>/?.*), $\{segment}

            # ========================================
            # Reservation Seat Service
            # ========================================
            - id: reservation-seat-service
              uri: lb://RESERVATION-SEAT-SERVICE
              predicates:
                - Path=/api/v1/reservation-seats/**
              filters:
                - RewritePath=/api/v1/reservation-seats(?<segment>/?.*), /api/v1/reservation-seats$\{segment}

            - id: reservation-seat-service-api-docs
              uri: lb://RESERVATION-SEAT-SERVICE
              predicates:
                - Path=/reservation-seat-service/v3/api-docs/**
              filters:
                - RewritePath=/reservation-seat-service(?<segment>/?.*), $\{segment}

            # ========================================
            # Art Hall Service
            # ========================================
            - id: arthall-service
              uri: lb://ARTHALL-SERVICE
              predicates:
                - Path=/api/v1/arthalls/**
              filters:
                - RewritePath=/api/v1/arthalls(?<segment>/?.*), /api/v1/arthalls$\{segment}

            - id: arthall-service-api-docs
              uri: lb://ARTHALL-SERVICE
              predicates:
                - Path=/arthall-service/v3/api-docs/**
              filters:
                - RewritePath=/arthall-service(?<segment>/?.*), $\{segment}

            # ========================================
            # Ticket Service
            # ========================================
            - id: ticket-service
              uri: lb://TICKET-SERVICE
              predicates:
                - Path=/api/v1/tickets/**
              filters:
                - RewritePath=/api/v1/tickets(?<segment>/?.*), /api/v1/tickets$\{segment}

            - id: ticket-service-api-docs
              uri: lb://TICKET-SERVICE
              predicates:
                - Path=/ticket-service/v3/api-docs/**
              filters:
                - RewritePath=/ticket-service(?<segment>/?.*), $\{segment}

# ========================================
# SpringDoc OpenAPI / Swagger 통합 설정
# ========================================
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: Auth Service
      - url: /auth-service/v3/api-docs
      - name: Art Hall Service
        url: /arthall-service/v3/api-docs
      - name: Product Service
        url: /product-service/v3/api-docs
      - name: Reservation Seat Service
        url: /reservation-seat-service/v3/api-docs
      - name: Reservation Service
        url: /reservation-service/v3/api-docs
      - name: Ticket Service
        url: /ticket-service/v3/api-docs
    urls-primary-name: Product Service

# ========================================
# Gateway Actuator
# ========================================
management:
  endpoint:
    gateway:
      enabled: true
  endpoints:
    web:
      exposure:
        include: health, info, prometheus, metrics, gateway

# ========================================
# Logging
# ========================================
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: DEBUG
    org.springframework.security.oauth2: DEBUG
